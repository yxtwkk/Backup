<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Lookup additional data in Spark Streaming | Yeeex</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><div id="link" rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"></div><div id="link" rel="stylesheet" href="https://libs.useso.com/js/font-awesome/4.2.0/css/font-awesome.min.css"></div><div id="link" rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css"></div><link rel="stylesheet" href="https://libs.baidu.com/fontawesome/4.0.3/css/font-awesome.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Lookup additional data in Spark Streaming</h1><a id="logo" href="/.">Yeeex</a><p class="description">æ„¿è‡ªç”±ä¸”å¼€é˜”</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Ãœber</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Lookup additional data in Spark Streaming</h1><div class="post-meta">Sep 28, 2018<span> | </span><span class="category"><a href="/categories/å¤§æ•°æ®ç³»ç»Ÿ/">å¤§æ•°æ®ç³»ç»Ÿ</a></span></div><div class="post-content"><p>åœ¨åˆ©ç”¨spark streamingå¤„ç†æµå¼æ•°æ®æ—¶ï¼Œæœ‰æ—¶ä¼šéœ€è¦ç”¨åˆ°å¤–éƒ¨çš„æ•°æ®ï¼Œè€Œä¸æ˜¯dstreamå–‚ç»™ç¨‹åºçš„æ•°æ®ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦æƒ³æ€»ç»“ä¸€ä¸‹ï¼Œspark streamingåˆ©ç”¨å¤–éƒ¨æ•°æ®çš„å‡ ç§æ–¹å¼ï¼š</p>
<p>ï¼ˆ1ï¼‰å¹¿æ’­ğŸ“¢Broadcast</p>
<p>ï¼ˆ2ï¼‰mapParitions</p>
<p>ï¼ˆ3ï¼‰mapParitions + connnection broadcast</p>
<p>ï¼ˆ4ï¼‰stateful stream</p>
<p>å…¶ä¸­ï¼Œstateful streamä¹‹å‰åœ¨researchçš„æ—¶å€™ç”¨è¿‡mapWithStateè¿›è¡ŒæµçŠ¶æ€çš„ç®¡ç†ï¼Œå°±å•ç‹¬å†™äº†ä¸€ç¯‡ã€‚æœ¬æ–‡é‡ç‚¹å†™å‰ä¸‰ç§</p>
<a id="more"></a>
<h2 id="Broadcast"><a href="#Broadcast" class="headerlink" title="Broadcast"></a>Broadcast</h2><p>å¹¿æ’­ğŸ“¢</p>
<p>sparkæä¾›ä¸€å¥—å®Œæ•´çš„å¹¿æ’­æœºåˆ¶ï¼Œå½“ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®å¹¿æ’­åˆ°å„ä¸ªèŠ‚ç‚¹</p>
<p>å½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå¹¿æ’­çš„å¥½å¤„å°±æ˜¯ ä¸ç”¨æ¯ä¸ªtaskéƒ½è®²é™æ€æ•°æ® static dataå‘é€åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ˜¯ä»¥worker nodeä¸ºå•ä½</p>
<p>ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯ å¹¿æ’­çš„æ•°æ®æ˜¯static dataï¼Œæ˜¯ä¸èƒ½æ›´æ”¹çš„ï¼›æˆ–è€…æ›´ç¡®åˆ‡è¯´ï¼Œå¹¿æ’­å˜é‡åœ¨å„ä¸ªworker nodeä¸Šæ˜¯åªè¯»çš„ï¼Œåœ¨driverç«¯æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„</p>
<p>å¦‚æœæ²¡æœ‰è¿›è¡Œå¹¿æ’­å˜é‡ï¼ŒnamesForIdå°†è¢«åºåˆ—åŒ–åˆ°æ¯ä¸€ä¸ªtaskä¸Š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> namesForId: <span class="type">Map</span>[<span class="type">Long</span>,<span class="type">String</span>] = <span class="type">Map</span>(<span class="number">1</span> -&gt; <span class="string">"Wheel-Temperature"</span>, <span class="number">2</span> -&gt; <span class="string">"Wheel-Pressure"</span>)</span><br><span class="line">stream.map (typId =&gt; (typId,namesForId(typId)))</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœè¿ç”¨å¹¿æ’­å˜é‡ï¼ŒnamesForIdå°†è¢«å¹¿æ’­åˆ°å„ä¸ªworkerèŠ‚ç‚¹</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> namesForId: <span class="type">Map</span>[<span class="type">Long</span>,<span class="type">String</span>] = <span class="type">Map</span>(<span class="number">1</span> -&gt; <span class="string">"Wheel-Temperature"</span>, <span class="number">2</span> -&gt; <span class="string">"Wheel-Pressure"</span>)</span><br><span class="line"><span class="keyword">val</span> namesForIdBroadcast = sc.broadcast(namesForId)</span><br><span class="line">stream.map (typId =&gt; (typId,namesForIdBroadcast.value(typId)))</span><br></pre></td></tr></table></figure>
<h2 id="MapPartitions"><a href="#MapPartitions" class="headerlink" title="MapPartitions"></a>MapPartitions</h2><p>å¯¹äºnon-staticçš„æ•°æ®å¯ä»¥é‡‡ç”¨mapçš„æ–¹å¼ï¼Œåºåˆ—åŒ–åˆ°æ¯ä¸ªtaskä¸Šï¼Œä½†æ˜¯è¿™æ ·åšçš„å¼€é”€å¤ªå¤§ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨mapPartition()ï¼›mapPartitions()å¹¶ä¸æ˜¯å¯¹æ¯ä¸€ä¸ªå…ƒç´ éƒ½è¿›è¡Œæ“çºµï¼Œè€Œæ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªpartitionï¼›</p>
<p>æ¯”å¦‚ï¼Œå¯¹äºè¿æ¥æ•°æ®åº“çš„æ“ä½œï¼Œè¿™å°±å¯ä»¥ä¿è¯æ¯ä¸ªpartitioné“¾æ¥ä¸€æ¬¡æ•°æ®åº“ï¼Œç„¶åè¿™ä¸ªpartitionçš„æ¯ä¸ªå…ƒç´ éƒ½å¤ç”¨è¿™ä¸ªé“¾æ¥</p>
<p>åœ¨é“¾æ¥æ•°æ®åº“æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæœ‰ä¸¤ç§ç­–ç•¥ï¼š</p>
<p>ï¼ˆ1ï¼‰é‡‡ç”¨bulk apiï¼Œæ‰¹é‡æ“ä½œå¤„ç†paritionçš„å…ƒç´ </p>
<p>ï¼ˆ2ï¼‰é‡‡ç”¨asynchronouså¼‚æ­¥çš„ï¼Œnon-blocking çš„apiï¼Œåˆ†åˆ«å¤„ç†partitioné‡Œçš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œèšåˆ</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wikiChanges.mapPartitions(elements =&gt; &#123;</span><br><span class="line">  <span class="type">Session</span> session = <span class="comment">// create database connection and session</span></span><br><span class="line">  <span class="type">PreparedStatement</span> preparedStatement = <span class="comment">// prepare statement, if supported by database</span></span><br><span class="line">  elements.map(element =&gt; &#123;</span><br><span class="line">    <span class="comment">// extract key from element and bind to prepared statement</span></span><br><span class="line">    <span class="type">BoundStatement</span> boundStatement = preparedStatement.bind(???)</span><br><span class="line">    session.asyncQuery(boundStatement) <span class="comment">// returns a Future</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .map(...) <span class="comment">//retrieve value from future</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¿æ¥æ•°æ®åº“è¿™ç§ä»£ä»·è¾ƒé«˜çš„æ“ä½œï¼Œæ¯ä¸ªpartitionæ‰åšä¸€æ¬¡</p>
<p>ğŸ’¡blocking &amp; synchronousæ˜¯ç›¸åŒçš„æ„æ€ï¼Œxè°ƒç”¨api yï¼Œå…ˆå°†xæŒ‚èµ·ï¼Œç›´åˆ°yæœ‰ä¸€äº›å¤„ç†ç»“æœæ‰è¿”å›</p>
<p>xå’Œyå¯ä»¥æ˜¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œæˆ–è€…ä¸€ä¸ªè¿›ç¨‹ä¸€ä¸ªçº¿ç¨‹</p>
<p>ğŸ’¡asynchronousè¡¨ç¤ºï¼Œxè°ƒç”¨api yï¼Œxåœ¨è°ƒç”¨åå¯ä»¥è¿›è¡Œå…¶ä»–è¿ç®—ï¼Œåªæœ‰å½“yè¿”å›æ—¶ï¼Œxä¼šå¾—åˆ°ç»“æœ</p>
<p>xå’Œyå¯ä»¥æ˜¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä½†æ˜¯ä¸å¯èƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹</p>
<p>ğŸ’¡non-blockingè¡¨ç¤ºï¼Œxè°ƒç”¨api yï¼Œxåœ¨è°ƒç”¨åå¯ä»¥è¿›è¡Œå…¶ä»–è¿ç®—ï¼Œxå¯èƒ½æ¯å‡ åˆ†é’Ÿæ¥checkä¸€ä¸‹yæ˜¯å¦å®Œæˆäº†è¿ç®—ï¼ˆåˆ†é’Ÿå¯ä»¥ä¸º0ï¼‰ï¼Œåªæœ‰å½“yè¿”å›æ—¶ï¼Œxä¼šå¾—åˆ°ç»“æœï¼Œxå’Œyå¯ä»¥æ˜¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œä½†æ˜¯ä¸å¯èƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹</p>
<p><strong>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å…¨å±€åšä¸€ä¸ªæ•°æ®åº“çš„é“¾æ¥ï¼Œç„¶åbroadcaståˆ°å„ä¸ªworker nodeèŠ‚ç‚¹ä¸Šå‘¢ï¼Ÿ</strong></p>
<p><strong>å› ä¸ºå¾ˆå¤šæ•°æ®åº“é“¾æ¥æ“ä½œæ˜¯non-serialized</strong></p>
<h2 id="Broadcast-Connection-MapPartitions"><a href="#Broadcast-Connection-MapPartitions" class="headerlink" title="Broadcast Connection + MapPartitions"></a>Broadcast Connection + MapPartitions</h2></div><div class="tags"></div><div class="post-nav"><a class="next" href="/2018/09/23/statefulstream/">Stateful Stream</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://yeeex.gitee.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/å¤§æ•°æ®ç³»ç»Ÿ/">å¤§æ•°æ®ç³»ç»Ÿ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://www.jianshu.com/u/590589380922" title="ç®€ä¹¦" target="_blank">ç®€ä¹¦</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2018 <a href="/." rel="nofollow">Yeeex.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>